<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CriptoSuite Profesional Web (Validado)</title>
    <style>
        :root {
            --bg-color: #f3f4f6;
            --surface-color: #ffffff;
            --text-color-primary: #1f2937;
            --text-color-secondary: #6b7280;
            --primary-color: #007aff;
            --primary-text-color: #ffffff;
            --border-color: #d1d5db;
            --error-color: #ef4444;
            --success-color: #10b981;
            --header-font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --body-font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --mono-font: "SF Mono", "Consolas", "Courier New", monospace;
        }

        body {
            font-family: var(--body-font);
            background-color: var(--bg-color);
            color: var(--text-color-primary);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Estilos Generales --- */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(243, 244, 246, 0.7); backdrop-filter: blur(25px) saturate(180%); -webkit-backdrop-filter: blur(25px) saturate(180%); z-index: 2000; opacity: 1; transition: opacity 0.7s cubic-bezier(0.4, 0, 0.2, 1); text-align: center; padding: 20px; }
        #splash-screen.hidden { opacity: 0; pointer-events: none; }
        .splash-content { transform: scale(0.95); opacity: 0; animation: fadeInScale 0.8s 0.2s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes fadeInScale { to { transform: scale(1); opacity: 1; } }
        #espol-logo-splash { width: 120px; height: auto; margin-bottom: 25px; }
        #splash-screen h1 { font-family: var(--header-font); font-size: 36px; font-weight: 600; color: #1d1d1f; margin: 0 0 10px 0; }
        #splash-screen p { font-size: 18px; color: var(--text-color-secondary); max-width: 450px; line-height: 1.6; margin-bottom: 30px; }
        #start-button { font-family: var(--header-font); background-color: var(--primary-color); color: white; border: none; padding: 14px 30px; border-radius: 50px; font-size: 18px; font-weight: 500; cursor: pointer; transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s; box-shadow: 0 4px 15px rgba(0, 122, 255, 0.2); }
        #start-button:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(0, 122, 255, 0.3); }
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 1500; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        #modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--surface-color); border-radius: 16px; padding: 25px; width: 90%; max-width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transform: scale(0.95); opacity: 0; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s; }
        #modal-overlay.visible .modal-content { transform: scale(1); opacity: 1; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-header h3 { font-size: 20px; font-weight: 600; margin: 0; }
        .modal-body { color: var(--text-color-secondary); font-size: 16px; line-height: 1.6; margin-bottom: 25px; }
        .modal-footer { text-align: right; }
        .modal-close-button { background-color: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer; }
        #main-app { display: flex; width: 100%; height: 100%; opacity: 0; visibility: hidden; transition: opacity 0.7s cubic-bezier(0.4, 0, 0.2, 1); }
        #main-app.visible { opacity: 1; visibility: visible; }
        .sidebar { background-color: var(--surface-color); padding: 20px; width: 250px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; box-shadow: 2px 0 5px rgba(0,0,0,0.05); flex-shrink: 0; }
        .sidebar-content { flex-grow: 1; }
        .sidebar h1 { font-family: var(--header-font); font-size: 24px; font-weight: 600; color: var(--primary-color); margin-top: 0; }
        .sidebar .nav-button { background-color: transparent; border: none; color: var(--text-color-secondary); font-weight: 500; padding: 12px; width: 100%; text-align: left; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: background-color 0.2s, color 0.2s; font-size: 16px; }
        .sidebar .nav-button:hover { background-color: var(--bg-color); color: var(--text-color-primary); }
        .sidebar .nav-button.active { background-color: var(--primary-color); color: var(--primary-text-color); }
        .sidebar-footer { margin-top: auto; padding-top: 20px; text-align: center; }
        #espol-logo-sidebar { width: 40px; height: auto; opacity: 0.6; }
        .sidebar-footer p { font-size: 14px; font-weight: 500; color: var(--text-color-secondary); margin: 5px 0 0 0; }
        .content-area { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .tool-container { display: none; }
        .tool-container.active { display: grid; grid-template-columns: minmax(320px, 1fr) 2fr; gap: 30px; height: 100%; max-height: calc(100vh - 60px);}
        .controls-panel, .output-panel { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03); overflow-y: auto; }
        .output-panel { display: flex; flex-direction: column; }
        h2 { font-family: var(--header-font); font-size: 22px; font-weight: 600; margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color-secondary); }
        .form-group fieldset { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; }
        .form-group fieldset legend { font-weight: 600; padding: 0 8px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-group input[readonly] { background-color: var(--bg-color); cursor: text; }
        .radio-group { display: flex; gap: 15px; }
        .action-button { background-color: var(--primary-color); color: var(--primary-text-color); font-weight: 500; border: none; padding: 12px 20px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.2s, transform 0.2s, opacity 0.2s; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .action-button:hover { transform: translateY(-1px); }
        .action-button:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; opacity: 0.7; }
        .result-display { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .result-display .result-title { font-size: 14px; font-weight: 600; color: var(--text-color-secondary); margin-bottom: 10px; }
        .result-display .result-text { font-family: var(--mono-font); font-size: 26px; font-weight: 600; word-wrap: break-word; color: var(--text-color-primary); }
        .steps-container { flex-grow: 1; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; }
        .steps-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .steps-table th, .steps-table td { border-bottom: 1px solid var(--border-color); padding: 10px 12px; text-align: left; word-break: break-all; }
        .steps-table tr:last-child td { border-bottom: none; }
        .steps-table th { background-color: var(--bg-color); font-weight: 600; color: var(--text-color-secondary); }
        #tcrCongruences button { padding: 5px 10px; margin-left: 5px; }
        hr { border: none; border-top: 1px solid var(--border-color); margin: 25px 0; }
        .validation-message { color: var(--error-color); font-size: 12px; margin-top: 4px; display: none; min-height: 1.2em; }
        .validation-message.success { color: var(--success-color); }
        input.invalid { border-color: var(--error-color); }
        input.invalid:focus { box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2); }
        #recursos.tool-container.active { display: block; }
        .resource-card { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03); display: flex; align-items: center; justify-content: space-between; }
        .resource-info h3 { margin: 0 0 5px 0; font-size: 18px; font-weight: 600; }
        .resource-info p { margin: 0; color: var(--text-color-secondary); }
        .resource-icon { width: 20px; height: 20px; }
    </style>
</head>
<body>
    <div id="splash-screen"><div class="splash-content"><img id="espol-logo-splash" src="https://upload.wikimedia.org/wikipedia/commons/d/d9/ESPOL_-_Logo_BN_002.svg" alt="Logo ESPOL"><h1>Bienvenido a CriptoSuite</h1><p>Una herramienta académica complementaria para el módulo de Criptografía<br><b>Escuela Superior Politécnica del Litoral</b></p><button id="start-button">Iniciar</button></div></div>
    
    <div id="main-app">
        <div class="sidebar">
            <div class="sidebar-content">
                <h1>CriptoSuite</h1>
                <!-- Menú Reorganizado -->
                <button class="nav-button active" data-tool="cesar">Cifrado César</button>
                <button class="nav-button" data-tool="afin">Cifrado Afín</button>
                <button class="nav-button" data-tool="euclides">Euclides y MCD</button>
                <button class="nav-button" data-tool="inverso">Inverso Multiplicativo Modular</button>
                <button class="nav-button" data-tool="tcr">Teorema Chino del Residuo</button>
                <hr>

                <button class="nav-button" data-tool="otp">One-Time Pad</button>
                <button class="nav-button" data-tool="rsa">Criptosistema RSA</button>
                <hr>
                <button class="nav-button" data-tool="recursos">Recursos y Descargas</button>
            </div>
            <div class="sidebar-footer">
                <img id="espol-logo-sidebar" src="https://upload.wikimedia.org/wikipedia/commons/d/d9/ESPOL_-_Logo_BN_002.svg" alt="Logo ESPOL">
                <p>ESPOL</p>
            </div>
        </div>
        <div class="content-area">
            <!-- Paneles de Herramientas (con variables ajustadas) -->
            <div id="cesar" class="tool-container active">
                <div class="controls-panel"><h2>Controles: Cifrado César</h2><div class="form-group"><label for="cesarText">Plaintext (P) / Ciphertext (C):</label><textarea id="cesarText" rows="4">HELLO WORLD</textarea></div><div class="form-group"><label for="cesarB">Parámetro shift (b):</label><input type="number" id="cesarB" value="3" min="0"></div><div class="form-group"><label>Modo:</label><div class="radio-group"><label><input type="radio" name="cesarMode" value="enc" checked> Encriptar (C ≡ P + b)</label><label><input type="radio" name="cesarMode" value="dec"> Desencriptar (P ≡ C - b)</label></div></div><hr><button class="action-button" id="cesarExecute">Ejecutar</button></div>
                <div class="output-panel"><div class="result-display"><div class="result-title">Resultado Final</div><div class="result-text" id="cesarResultText">-</div></div><h2>Proceso Matemático</h2><div class="steps-container"><table class="steps-table" id="cesarStepsTable"></table></div></div>
            </div>
            <div id="afin" class="tool-container">
                <div class="controls-panel"><h2>Controles: Cifrado Afín</h2><div class="form-group"><label for="afinText">Plaintext (P) / Ciphertext (C):</label><textarea id="afinText" rows="4">AFFINE CIPHER</textarea></div><div class="form-group"><label for="afinA">Parámetro (a):</label><select id="afinA"></select><div class="validation-message success" style="display:block;">Valores de 'a' que aseguran mcd(a, 26)=1.</div></div><div class="form-group"><label for="afinB">Parámetro (b):</label><input type="number" id="afinB" value="8" min="0"></div><div class="form-group"><label>Modo:</label><div class="radio-group"><label><input type="radio" name="afinMode" value="enc" checked> Encriptar (C ≡ aP + b)</label><label><input type="radio" name="afinMode" value="dec"> Desencriptar (P ≡ a⁻¹(C-b))</label></div></div><hr><button class="action-button" id="afinExecute">Ejecutar</button></div>
                <div class="output-panel"><div class="result-display"><div class="result-title">Resultado Final</div><div class="result-text" id="afinResultText">-</div></div><h2>Proceso Matemático</h2><div class="steps-container"><table class="steps-table" id="afinStepsTable"></table></div></div>
            </div>
            <div id="vigenere" class="tool-container">
                <div class="controls-panel"><h2>Controles: Criptosistema Vigenère</h2><div class="form-group"><label for="vigenereText">Plaintext (p) / Ciphertext (c):</label><textarea id="vigenereText" rows="4">ATTACK AT DAWN</textarea></div><div class="form-group"><label for="vigenereKey">Llave (k):</label><input type="text" id="vigenereKey" value="LEMON"></div><div class="form-group"><label>Modo:</label><div class="radio-group"><label><input type="radio" name="vigenereMode" value="enc" checked> Encriptar (cᵢ ≡ pᵢ + kᵢ)</label><label><input type="radio" name="vigenereMode" value="dec"> Desencriptar (pᵢ ≡ cᵢ - kᵢ)</label></div></div><hr><button class="action-button" id="vigenereExecute">Ejecutar</button></div>
                <div class="output-panel"><div class="result-display"><div class="result-title">Resultado Final</div><div class="result-text" id="vigenereResultText">-</div></div><h2>Proceso Matemático</h2><div class="steps-container"><table class="steps-table" id="vigenereStepsTable"></table></div></div>
            </div>
            <div id="otp" class="tool-container">
                <div class="controls-panel"><h2>Controles: One-Time Pad</h2><div class="form-group"><label for="otpText">Mensaje (m):</label><textarea id="otpText" rows="4">SECRET MESSAGE</textarea></div><div class="form-group"><label for="otpKey">Llave (k):</label><input type="text" id="otpKey"><div id="otp-validation" class="validation-message"></div></div><button id="otpGenerateKey" class="action-button" style="background-color: #34c759;">Generar Llave Aleatoria</button><div class="form-group" style="margin-top: 15px;"><label>Modo:</label><div class="radio-group"><label><input type="radio" name="otpMode" value="enc" checked> Encriptar (c = m ⊕ k)</label><label><input type="radio" name="otpMode" value="dec"> Desencriptar (m = c ⊕ k)</label></div></div><hr><button class="action-button" id="otpExecute">Ejecutar</button></div>
                <div class="output-panel"><div class="result-display"><div class="result-title">Resultado Final</div><div class="result-text" id="otpResultText">-</div></div><h2>Proceso Matemático (cᵢ ≡ pᵢ + kᵢ mod 26)</h2><div class="steps-container"><table class="steps-table" id="otpStepsTable"></table></div></div>
            </div>
            <div id="rsa" class="tool-container">
                <div class="controls-panel"><h2>Controles: Criptosistema RSA</h2><div class="form-group"><fieldset><legend>1. Generación de Claves</legend><label for="rsaP">Número primo (p):</label><input type="number" id="rsaP" value="61"><div id="rsaP-validation" class="validation-message"></div><label for="rsaQ">Número primo (q):</label><input type="number" id="rsaQ" value="53"><div id="rsaQ-validation" class="validation-message"></div><label for="rsaE">Exponente público (e):</label><input type="number" id="rsaE" value="17"><div id="rsaE-validation" class="validation-message"></div><button id="rsaGenerateKeys" class="action-button" style="margin-top: 10px;">Generar y Mostrar Claves</button><hr><label>Clave Pública (N, e):</label><input type="text" id="rsaPublicKey" readonly><label>Clave Privada (d):</label><input type="text" id="rsaPrivateKey" readonly><label>Módulo (N = pq):</label><input type="text" id="rsaN" readonly><label>Función de Euler (φ(N)):</label><input type="text" id="rsaPhiN" readonly></fieldset></div><div class="form-group"><fieldset><legend>2. Operación</legend><label for="rsaText">Mensaje (m) / Ciphertext (c):</label><textarea id="rsaText" rows="3">RSA ENCRYPTED</textarea><div class="radio-group" style="margin-top:10px;"><label><input type="radio" name="rsaMode" value="enc" checked> Encriptar (c ≡ mᵉ mod N)</label><label><input type="radio" name="rsaMode" value="dec"> Desencriptar (m ≡ cᵈ mod N)</label></div></fieldset></div><hr><button class="action-button" id="rsaExecute">Ejecutar</button></div>
                <div class="output-panel"><div class="result-display"><div class="result-title">Resultado Final</div><div class="result-text" id="rsaResultText">-</div></div><h2>Proceso Matemático</h2><div class="steps-container"><table class="steps-table" id="rsaStepsTable"></table></div></div>
            </div>
            <div id="euclides" class="tool-container">
                <div class="controls-panel"><h2>Controles: Euclides y MCD</h2><div class="form-group"><label for="euclidesA">Entero (a):</label><input type="number" id="euclidesA" value="391"></div><div class="form-group"><label for="euclidesB">Entero (b):</label><input type="number" id="euclidesB" value="299"></div><hr><button class="action-button" id="euclidesExecute">Calcular</button></div>
                <div class="output-panel"><div class="result-display"><div class="result-title">Resultado Final</div><div class="result-text" id="euclidesResultText">-</div></div><h2>Proceso Matemático (Algoritmo Extendido de Euclides)</h2><div class="steps-container"><table class="steps-table" id="euclidesStepsTable"></table></div></div>
            </div>
            <div id="inverso" class="tool-container">
                <div class="controls-panel"><h2>Controles: Inverso Multiplicativo Modular</h2><div class="form-group"><label for="inversoA">Entero (a):</label><input type="number" id="inversoA" value="17"></div><div class="form-group"><label for="inversoM">Módulo (m):</label><input type="number" id="inversoM" value="20"><div id="inverso-validation" class="validation-message"></div></div><hr><button class="action-button" id="inversoExecute">Calcular Inverso</button></div>
                <div class="output-panel"><div class="result-display"><div class="result-title">Resultado Final</div><div class="result-text" id="inversoResultText">-</div></div><h2>Proceso Matemático (Algoritmo Extendido de Euclides)</h2><div class="steps-container"><table class="steps-table" id="inversoStepsTable"></table></div></div>
            </div>
            <div id="tcr" class="tool-container">
                <div class="controls-panel"><h2>Controles: T. Chino del Residuo</h2><div class="form-group" id="tcrCongruences"><label>Sistema de Congruencias n ≡ rᵢ (mod nᵢ):</label></div><div id="tcr-validation" class="validation-message"></div><button id="tcrAddRow" class="action-button" style="background-color: #34c759; margin-top: 10px;">Añadir Congruencia</button><hr><button class="action-button" id="tcrExecute">Resolver Sistema</button></div>
                <div class="output-panel"><div class="result-display"><div class="result-title">Resultado Final</div><div class="result-text" id="tcrResultText">-</div></div><h2>Proceso Matemático</h2><div class="steps-container"><table class="steps-table" id="tcrStepsTable"></table></div></div>
            </div>
            <div id="recursos" class="tool-container">
                <div style="grid-column: 1 / -1;"><div class="resource-card"><div class="resource-info"><h3>Aplicación de Escritorio (Windows)</h3><p>Versión ejecutable (.exe) que no requiere tener Python instalado.</p></div><a href="./CriptoSuite.exe" download class="action-button"><svg class="resource-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg> Descargar (.exe)</a></div><div class="resource-card"><div class="resource-info"><h3>Código Fuente (Python)</h3><p>Script .py de la aplicación de escritorio. Requiere Python y sv-ttk.</p></div><a href="./criptosuite.py" download class="action-button"><svg class="resource-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg> Descargar (.py)</a></div><div class="resource-card"><div class="resource-info"><h3>Código Fuente (Página Web)</h3><p>El código fuente de esta misma página web, listo para usar localmente.</p></div><a href="./criptosuite.html" download class="action-button"><svg class="resource-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg> Descargar (.html)</a></div></div>
            </div>
        </div>
    </div>
    <div id="modal-overlay"><div class="modal-content"><div class="modal-header"><h3 id="modal-title">Error</h3></div><div class="modal-body"><p id="modal-message"></p></div><div class="modal-footer"><button id="modal-close" class="modal-close-button">Entendido</button></div></div></div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const splashScreen = document.getElementById('splash-screen');
    const mainApp = document.getElementById('main-app');
    const startButton = document.getElementById('start-button');
    startButton.addEventListener('click', () => {
        splashScreen.classList.add('hidden');
        mainApp.classList.add('visible');
        setTimeout(() => { splashScreen.style.display = 'none'; }, 700);
    });
    const modal = {
        overlay: document.getElementById('modal-overlay'),
        title: document.getElementById('modal-title'),
        message: document.getElementById('modal-message'),
        init() {
            document.getElementById('modal-close').addEventListener('click', () => this.hide());
            this.overlay.addEventListener('click', (e) => { if (e.target === this.overlay) this.hide(); });
        },
        show(title, message) { this.title.textContent = title; this.message.textContent = message; this.overlay.classList.add('visible'); },
        hide() { this.overlay.classList.remove('visible'); }
    };
    modal.init();
    const app = {
        ALPHABET: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
        mcd(a, b) { a = Math.abs(a); b = Math.abs(b); while (b) { [a, b] = [b, a % b]; } return a; },
        egcd(a, b) { if (a === 0) return [b, 0, 1]; const [g, y, x] = this.egcd(b % a, a); return [g, x - Math.floor(b / a) * y, y]; },
        modinv(a, m) { const [g, x, y] = this.egcd(a, m); if (g !== 1) throw new Error(`La inversa modular de ${a} mod ${m} no existe (MCD=${g} ≠ 1).`); return (x % m + m) % m; },
        power(base, exp, mod) { let res = 1n; base = BigInt(base); exp = BigInt(exp); mod = BigInt(mod); base %= mod; while (exp > 0) { if (exp % 2n === 1n) res = (res * base) % mod; exp = exp >> 1n; base = (base * base) % mod; } return Number(res); },
        isPrime(num) { if (num <= 1) return false; if (num <= 3) return true; if (num % 2 === 0 || num % 3 === 0) return false; for (let i = 5; i * i <= num; i = i + 6) { if (num % i === 0 || num % (i + 2) === 0) return false; } return true; },
        caesar_cipher(text, b, decrypt = false) { const op = decrypt ? -1 : 1, effectiveK = op * b; let result = ''; const steps = []; for (const char of text) { if (this.ALPHABET.includes(char.toUpperCase())) { const charCode = char.charCodeAt(0), base = charCode >= 97 ? 97 : 65; const P = charCode - base; const C = (P + effectiveK + 2600) % 26; // Added 2600 to handle large negative numbers
 const newChar = String.fromCharCode(base + C); result += newChar; steps.push({ in: `'${char}' (P=${P})`, calc: `(${P} ${decrypt ? '-' : '+'} ${b}) mod 26`, out: `'${newChar}' (C=${C})` }); } else { result += char; steps.push({ in: `'${char}'`, calc: 'No es letra', out: `'${char}'` }); } } return { result, steps }; },
        affine_cipher(text, a, b, decrypt = false) { let result = ''; const steps = []; if (decrypt) { const a_inv = this.modinv(a, 26); steps.push({ header: `Paso 1: Inversa de a=${a} mod 26 => a⁻¹=${a_inv}` }); for (const char of text) { if (this.ALPHABET.includes(char.toUpperCase())) { const C = this.ALPHABET.indexOf(char.toUpperCase()); const P = (a_inv * (C - b) + 2600) % 26; // Added 2600
 const newChar = this.ALPHABET[P]; result += char === char.toLowerCase() ? newChar.toLowerCase() : newChar; steps.push({ in: `'${char}' (C=${C})`, calc: `${a_inv}*(${C}-${b}) mod 26`, out: `'${newChar}' (P=${P})` }); } else { result += char; steps.push({ in: `'${char}'`, calc: 'No es letra', out: `'${char}'` }); } } } else { for (const char of text) { if (this.ALPHABET.includes(char.toUpperCase())) { const P = this.ALPHABET.indexOf(char.toUpperCase()); const C = (a * P + b) % 26; const newChar = this.ALPHABET[C]; result += char === char.toLowerCase() ? newChar.toLowerCase() : newChar; steps.push({ in: `'${char}' (P=${P})`, calc: `(${a}*${P}+${b}) mod 26`, out: `'${newChar}' (C=${C})` }); } else { result += char; steps.push({ in: `'${char}'`, calc: 'No es letra', out: `'${char}'` }); } } } return { result, steps }; },
        vigenere_cipher(text, key, decrypt = false) { const cleanKey = key.toUpperCase().replace(/[^A-Z]/g, ''); if (!cleanKey) throw new Error("La llave debe contener letras."); let result = '', steps = [], keyIndex = 0; for (const char of text) { if (this.ALPHABET.includes(char.toUpperCase())) { const k_char = cleanKey[keyIndex % cleanKey.length]; const k_shift = this.ALPHABET.indexOf(k_char); const { result: sub_res, steps: sub_steps } = this.caesar_cipher(char, k_shift, decrypt); result += sub_res; steps.push({in: `'${char}'`, key: `'${k_char}'`, shift: k_shift, calc: sub_steps[0].calc, out: sub_steps[0].out}); keyIndex++; } else { result += char; steps.push({in: `'${char}'`, key: 'N/A', shift: 'N/A', calc: 'No es letra', out: `'${char}'`}); } } return { result, steps }; },
        one_time_pad_cipher(text, key, decrypt = false) { const cleanKey = key.toUpperCase().replace(/[^A-Z]/g, ''); const cleanText = text.toUpperCase().replace(/[^A-Z]/g, ''); if (cleanKey.length !== cleanText.length) throw new Error("La longitud del mensaje (solo letras) y la llave deben ser iguales."); let result = '', steps = [], textIndex = 0; for (let i = 0; i < text.length; i++) { const char = text[i]; if (this.ALPHABET.includes(char.toUpperCase())) { const k_char = cleanKey[textIndex]; const k_shift = this.ALPHABET.indexOf(k_char); const { result: sub_res, steps: sub_steps } = this.caesar_cipher(char, k_shift, decrypt); result += sub_res; steps.push({in: `'${char}'`, key: `'${k_char}'`, shift: k_shift, calc: sub_steps[0].calc, out: sub_steps[0].out}); textIndex++; } else { result += char; steps.push({in: `'${char}'`, key: 'N/A', shift: 'N/A', calc: 'No es letra', out: `'${char}'`}); } } return { result, steps }; },
        rsa_cipher(text, N, key, mode) { const steps = []; if (mode === 'enc') { const result = []; for (let i = 0; i < text.length; i++) { const m = text.charCodeAt(i); if (m >= N) throw new Error(`El valor del caracter '${text[i]}' (ASCII=${m}) es >= que N=${N}. Use p y q más grandes.`); const c = this.power(m, key, N); result.push(c); steps.push({ in: `'${text[i]}' (m=${m})`, calc: `c = ${m}^${key} mod ${N}`, res: `c = ${c}` }); } return { result: result.join(','), steps }; } else { let result = ''; const cipher_nums = text.split(',').map(n => parseInt(n.trim(), 10)); for (const c of cipher_nums) { if (isNaN(c)) throw new Error(`Ciphertext '${text}' contiene valores no numéricos.`); const m = this.power(c, key, N); result += String.fromCharCode(m); steps.push({ in: `c=${c}`, calc: `m = ${c}^${key} mod ${N}`, res: `m = ${m} ('${String.fromCharCode(m)}')` }); } return { result, steps }; } },
        
        euclides_algorithm(initial_a, initial_b) {
            const steps = [];
            const fa = initial_a;
            const fb = initial_b;
            let a = Math.abs(initial_a);
            let b = Math.abs(initial_b);
            let prevx = 1, x = 0;
            let prevy = 0, y = 1;
            while (b) {
                const q = Math.floor(a / b);
                const r = a % b;
                const division_step = `${a} = ${b} * ${q} + ${r}`;
                let temp_x = x;
                x = prevx - q * x;
                prevx = temp_x;
                let temp_y = y;
                y = prevy - q * y;
                prevy = temp_y;
                const bezout_step = r ? `${r} = ${fa}(${x}) + ${fb}(${y})` : '---';
                steps.push({ division: division_step, bezout: bezout_step });
                [a, b] = [b, r];
            }
            const g = a;
            const x_final = prevx;
            const y_final = prevy;
            const result = `mcd(${initial_a}, ${initial_b}) = ${g} | Representación: ${initial_a}(${x_final}) + ${initial_b}(${y_final}) = ${g}`;
            return { result, steps };
        },

        chinese_remainder_theorem(congruences) {
            const steps = [];
            if (congruences.length < 2) throw new Error("Se necesitan al menos dos congruencias.");

            const moduli = congruences.map(c => c.n);
            for (let i = 0; i < moduli.length; i++) {
                if (moduli[i] <= 1) throw new Error(`El módulo n_${i+1}=${moduli[i]} debe ser > 1.`);
                for (let j = i + 1; j < moduli.length; j++) {
                    const g = this.mcd(moduli[i], moduli[j]);
                    if (g !== 1) throw new Error(`Módulos no son coprimos: mcd(${moduli[i]}, ${moduli[j]}) = ${g}. No se puede usar el método estándar.`);
                }
            }
            
            let { a: r1, n: n1 } = congruences[0];

            for (let i = 1; i < congruences.length; i++) {
                const { a: r2, n: n2 } = congruences[i];
                steps.push({ header: `Resolviendo sistema parcial:` });
                steps.push({ step: `n ≡ ${r1} (mod ${n1})` });
                steps.push({ step: `n ≡ ${r2} (mod ${n2})` });
                const [g, x, y] = this.egcd(n1, n2);
                steps.push({ step: `gcdext(${n1}, ${n2})`, calc: `1 = ${n1}(${x}) + ${n2}(${y})`, res: `x=${x}, y=${y}` });
                let n12 = BigInt(r1) * BigInt(y) * BigInt(n2) + BigInt(r2) * BigInt(x) * BigInt(n1);
                steps.push({ step: `n_1,2 = r₁*y*n₂ + r₂*x*n₁`, calc: `${r1}(${y})(${n2}) + ${r2}(${x})(${n1})`, res: `= ${n12}` });
                const new_mod = BigInt(n1) * BigInt(n2);
                r1 = Number((n12 % new_mod + new_mod) % new_mod);
                n1 = Number(new_mod);
                steps.push({ step: "Nueva congruencia", calc: `n ≡ ${n12} (mod ${new_mod})`, res: `n ≡ ${r1} (mod ${n1})`});
            }
            const N = moduli.reduce((acc, val) => BigInt(acc) * BigInt(val), 1n);
            const result = `n ≡ ${r1} (mod ${N})`;
            return { result, steps };
        },
        updateTable(tableId, headers, data, mapping) { const table = document.getElementById(tableId); table.innerHTML = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody></tbody>`; const tbody = table.querySelector('tbody'); data.forEach(rowData => { if (rowData.header) { tbody.innerHTML += `<tr><td colspan="${headers.length}" style="background-color: var(--bg-color); font-weight: bold;">${rowData.header}</td></tr>`; } else { const row = document.createElement('tr'); mapping.forEach(key => { const cell = document.createElement('td'); cell.textContent = rowData[key] !== undefined ? rowData[key] : ''; row.appendChild(cell); }); tbody.appendChild(row); } }); },
        init() { this.setupNavigation(); this.setupCesar(); this.setupAfin(); this.setupVigenere(); this.setupEuclides(); this.setupInverso(); this.setupTCR(); this.setupOTP(); this.setupRSA(); },
        setupNavigation() { const navButtons = document.querySelectorAll('.nav-button'); const toolContainers = document.querySelectorAll('.tool-container'); navButtons.forEach(button => { button.addEventListener('click', () => { const tool = button.getAttribute('data-tool'); navButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); toolContainers.forEach(container => { container.classList.remove('active'); if (container.id === tool) container.classList.add('active'); }); }); }); },
        setupCesar() { document.getElementById('cesarExecute').addEventListener('click', () => { try { const text = document.getElementById('cesarText').value; const b = parseInt(document.getElementById('cesarB').value, 10); if (isNaN(b) || b < 0) throw new Error("El parámetro shift 'b' debe ser un entero no negativo."); const { result, steps } = this.caesar_cipher(text, b, document.querySelector('input[name="cesarMode"]:checked').value === 'dec'); document.getElementById('cesarResultText').textContent = result; this.updateTable('cesarStepsTable', ['Entrada', 'Cálculo', 'Salida'], steps, ['in', 'calc', 'out']); } catch (e) { modal.show('Error en Cifrado César', e.message); } }); },
        setupAfin() { const selectA = document.getElementById('afinA'); [1, 3, 5, 7, 9, 11, 15, 17, 19, 21, 23, 25].forEach(val => { const option = document.createElement('option'); option.value = val; option.textContent = val; selectA.appendChild(option); }); selectA.value = 5; document.getElementById('afinExecute').addEventListener('click', () => { try { const text = document.getElementById('afinText').value; const a = parseInt(document.getElementById('afinA').value, 10); const b = parseInt(document.getElementById('afinB').value, 10); if (isNaN(b) || b < 0) throw new Error("El parámetro 'b' debe ser un entero no negativo."); const decrypt = document.querySelector('input[name="afinMode"]:checked').value === 'dec'; const { result, steps } = this.affine_cipher(text, a, b, decrypt); document.getElementById('afinResultText').textContent = result; const headers = decrypt ? ['Entrada (C)', 'Cálculo (P)', 'Salida (P)'] : ['Entrada (P)', 'Cálculo (C)', 'Salida (C)']; this.updateTable('afinStepsTable', headers, steps, ['in', 'calc', 'out']); } catch (e) { modal.show('Error en Cifrado Afín', e.message); } }); },
        setupVigenere() { document.getElementById('vigenereExecute').addEventListener('click', () => { try { const { result, steps } = this.vigenere_cipher(document.getElementById('vigenereText').value, document.getElementById('vigenereKey').value, document.querySelector('input[name="vigenereMode"]:checked').value === 'dec'); document.getElementById('vigenereResultText').textContent = result; this.updateTable('vigenereStepsTable', ['Entrada (pᵢ/cᵢ)', 'Llave (kᵢ)', 'Shift', 'Cálculo', 'Salida'], steps, ['in', 'key', 'shift', 'calc', 'out']); } catch (e) { modal.show('Error en Criptosistema Vigenère', e.message); } }); },
        setupOTP() {
            const textInput = document.getElementById('otpText'); const keyInput = document.getElementById('otpKey'); const validationMsg = document.getElementById('otp-validation'); const execButton = document.getElementById('otpExecute');
            const validate = () => {
                const text = textInput.value.toUpperCase().replace(/[^A-Z]/g, ''); const key = keyInput.value.toUpperCase().replace(/[^A-Z]/g, '');
                if (text.length > 0 && key.length > 0 && text.length === key.length) { validationMsg.textContent = 'Correcto: Longitudes de mensaje y llave coinciden.'; validationMsg.className = 'validation-message success'; execButton.disabled = false;
                } else if (text.length > 0 || key.length > 0) { validationMsg.textContent = `Error: Longitudes deben ser iguales (Mensaje: ${text.length}, Llave: ${key.length})`; validationMsg.className = 'validation-message'; execButton.disabled = true; 
                } else { validationMsg.textContent = ''; execButton.disabled = true; }
                validationMsg.style.display = 'block';
            };
            [textInput, keyInput].forEach(el => el.addEventListener('input', validate));
            document.getElementById('otpGenerateKey').addEventListener('click', () => { const text = textInput.value.toUpperCase().replace(/[^A-Z]/g, ''); let randomKey = ''; for (let i = 0; i < text.length; i++) { randomKey += this.ALPHABET[Math.floor(Math.random() * 26)]; } keyInput.value = randomKey; validate(); });
            document.getElementById('otpExecute').addEventListener('click', () => { try { const { result, steps } = this.one_time_pad_cipher(textInput.value, keyInput.value, document.querySelector('input[name="otpMode"]:checked').value === 'dec'); document.getElementById('otpResultText').textContent = result; this.updateTable('otpStepsTable', ['Entrada', 'Llave', 'Shift', 'Cálculo', 'Salida'], steps, ['in', 'key', 'shift', 'calc', 'out']); } catch (e) { modal.show('Error en One-Time Pad', e.message); } });
            validate();
        },
        setupRSA() {
            const p_input = document.getElementById('rsaP'); const q_input = document.getElementById('rsaQ'); const e_input = document.getElementById('rsaE');
            const p_val = document.getElementById('rsaP-validation'); const q_val = document.getElementById('rsaQ-validation'); const e_val = document.getElementById('rsaE-validation');
            const gen_button = document.getElementById('rsaGenerateKeys'); const exec_button = document.getElementById('rsaExecute');
            const validate_rsa_inputs = () => {
                let p_ok = false, q_ok = false, e_ok = false;
                const p = parseInt(p_input.value, 10); const q = parseInt(q_input.value, 10); const e = parseInt(e_input.value, 10);
                
                // VALIDACIÓN DE P
                if (!isNaN(p)) { if (!this.isPrime(p)) { p_val.textContent = "Error: p debe ser un número primo."; p_val.style.display = 'block'; p_input.classList.add('invalid'); } else { p_val.style.display = 'none'; p_input.classList.remove('invalid'); p_ok = true; } } else { p_val.style.display = 'none'; p_input.classList.remove('invalid'); }
                
                // VALIDACIÓN DE Q
                if (!isNaN(q)) { if (!this.isPrime(q)) { q_val.textContent = "Error: q debe ser un número primo."; q_val.style.display = 'block'; q_input.classList.add('invalid'); } else if (p_ok && p === q) { q_val.textContent = "Error: p y q no pueden ser iguales."; q_val.style.display = 'block'; q_input.classList.add('invalid'); } else { q_val.style.display = 'none'; q_input.classList.remove('invalid'); q_ok = true; } } else { q_val.style.display = 'none'; q_input.classList.remove('invalid'); }
                
                // VALIDACIÓN DE E
                if (p_ok && q_ok) { const phiN = (p - 1) * (q - 1); if (!isNaN(e)) { if (e <= 1 || e >= phiN) { e_val.textContent = `Error: e debe estar entre 1 y φ(N)=${phiN}.`; e_val.style.display = 'block'; e_input.classList.add('invalid'); } else if (this.mcd(e, phiN) !== 1) { e_val.textContent = `Error: e debe ser coprimo con φ(N)=${phiN}.`; e_val.style.display = 'block'; e_input.classList.add('invalid');} else { e_val.style.display = 'none'; e_input.classList.remove('invalid'); e_ok = true; } } else { e_val.style.display = 'none'; e_input.classList.remove('invalid'); }
                } else { e_val.textContent = 'p y q deben ser válidos primero.'; e_val.style.display = 'block'; e_input.classList.add('invalid'); }
                
                gen_button.disabled = !(p_ok && q_ok && e_ok);
            };
            [p_input, q_input, e_input].forEach(el => el.addEventListener('input', validate_rsa_inputs));
            const generateKeys = () => { try { validate_rsa_inputs(); if (gen_button.disabled) { throw new Error("Los parámetros p, q, o e no son válidos.");} const p = parseInt(p_input.value, 10); const q = parseInt(q_input.value, 10); const e = parseInt(e_input.value, 10); const N = p * q; const phiN = (p - 1) * (q - 1); const d = this.modinv(e, phiN); document.getElementById('rsaN').value = N; document.getElementById('rsaPhiN').value = phiN; document.getElementById('rsaPublicKey').value = `(${N}, ${e})`; document.getElementById('rsaPrivateKey').value = d; exec_button.disabled = false; } catch(e) { modal.show('Error en Generación de Claves', e.message); exec_button.disabled = true; } };
            gen_button.addEventListener('click', generateKeys);
            exec_button.addEventListener('click', () => { try { const N = parseInt(document.getElementById('rsaN').value, 10); const mode = document.querySelector('input[name="rsaMode"]:checked').value; const key = (mode === 'enc') ? parseInt(e_input.value, 10) : parseInt(document.getElementById('rsaPrivateKey').value, 10); if (isNaN(N) || isNaN(key)) throw new Error("Genere o verifique las claves primero."); const { result, steps } = this.rsa_cipher(document.getElementById('rsaText').value, N, key, mode); document.getElementById('rsaResultText').textContent = result; const headers = (mode === 'enc') ? ['Entrada (m)', 'Cálculo', 'Resultado (c)'] : ['Entrada (c)', 'Cálculo', 'Resultado (m)']; this.updateTable('rsaStepsTable', headers, steps, ['in', 'calc', 'res']); } catch(e) { modal.show('Error en RSA', e.message); } });
            validate_rsa_inputs(); generateKeys();
        },
        
        setupEuclides() { document.getElementById('euclidesExecute').addEventListener('click', () => { try { const a = parseInt(document.getElementById('euclidesA').value, 10); const b = parseInt(document.getElementById('euclidesB').value, 10); if (isNaN(a) || isNaN(b)) throw new Error("a y b deben ser enteros."); if (a === 0 && b === 0) throw new Error("mcd(0,0) no está definido."); const { result, steps } = this.euclides_algorithm(a, b); document.getElementById('euclidesResultText').textContent = result; this.updateTable('euclidesStepsTable', ['Paso de División', 'Representación Intermedia del Resto'], steps, ['division', 'bezout']); } catch (e) { modal.show('Error en Euclides', e.message); } }); },

        setupInverso() {
            const a_input = document.getElementById('inversoA'); const m_input = document.getElementById('inversoM');
            const validationMsg = document.getElementById('inverso-validation'); const execButton = document.getElementById('inversoExecute');
            const validate = () => {
                const a_str = a_input.value; const m_str = m_input.value;
                if (!a_str || !m_str) { execButton.disabled = true; validationMsg.style.display = 'none'; return; }
                const a = parseInt(a_str, 10); const m = parseInt(m_str, 10);
                if(isNaN(a) || isNaN(m) || m <= 1) { validationMsg.textContent = 'a y m deben ser enteros, con m > 1.'; validationMsg.className = 'validation-message'; execButton.disabled = true; validationMsg.style.display = 'block'; return; }
                const g = this.mcd(a, m);
                if (g === 1) { validationMsg.textContent = `mcd(${a}, ${m}) = 1. El inverso existe.`; validationMsg.className = 'validation-message success'; execButton.disabled = false;
                } else { validationMsg.textContent = `Error: mcd(${a}, ${m}) = ${g} ≠ 1. El inverso NO existe.`; validationMsg.className = 'validation-message'; execButton.disabled = true; }
                validationMsg.style.display = 'block';
            };
            [a_input, m_input].forEach(el => el.addEventListener('input', validate));
            execButton.addEventListener('click', () => {
                try {
                    const a = parseInt(a_input.value, 10); const m = parseInt(m_input.value, 10);
                    const inv = this.modinv(a, m); const [g, x, y] = this.egcd(a,m);
                    const steps = [
                        { step: "1. Verificar Condición (Coprimos)", calc: `mcd(${a}, ${m})`, res: g },
                        { step: "2. Usar Euclides Extendido", calc: `${a}(x) + ${m}(y) = ${g}`, res: `x=${x}, y=${y}`},
                        { step: "3. Calcular Inverso (ā)", calc: `ā ≡ x mod m`, res: `${x} mod ${m} = ${inv}`}
                    ];
                    document.getElementById('inversoResultText').textContent = `ā = ${a}⁻¹ ≡ ${inv} (mod ${m})`;
                    this.updateTable('inversoStepsTable', ['Paso', 'Cálculo', 'Resultado'], steps, ['step', 'calc', 'res']);
                } catch (e) { modal.show('Error en Inverso Modular', e.message); }
            });
            validate();
        },

        setupTCR() {
            const container = document.getElementById('tcrCongruences');
            const execButton = document.getElementById('tcrExecute');
            const validationMsg = document.getElementById('tcr-validation');
            
            const validateTCR = () => {
                const moduli = [];
                container.querySelectorAll('.tcrN').forEach(input => {
                    const n = parseInt(input.value, 10);
                    if (!isNaN(n)) moduli.push(n);
                });

                if (moduli.length < 2) {
                    validationMsg.style.display = 'none';
                    execButton.disabled = false; // Permitir ejecución para que la función interna muestre el error.
                    return;
                }

                for (let i = 0; i < moduli.length; i++) {
                    for (let j = i + 1; j < moduli.length; j++) {
                        const g = this.mcd(moduli[i], moduli[j]);
                        if (g !== 1) {
                            validationMsg.textContent = `Error: Los módulos no son coprimos en pares. mcd(${moduli[i]}, ${moduli[j]}) = ${g}.`;
                            validationMsg.className = 'validation-message';
                            validationMsg.style.display = 'block';
                            execButton.disabled = true;
                            return;
                        }
                    }
                }
                validationMsg.textContent = `Éxito: Todos los módulos son coprimos en pares.`;
                validationMsg.className = 'validation-message success';
                validationMsg.style.display = 'block';
                execButton.disabled = false;
            };

            const addRow = (aVal = '', nVal = '') => {
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '8px';
                div.style.marginBottom = '8px';
                div.innerHTML = `<span>n ≡</span> <input type="number" class="tcrA" value="${aVal}" style="width: 70px;"> <span>(mod</span> <input type="number" class="tcrN" value="${nVal}" style="width: 70px;"><span>)</span> <button class="tcrRemoveRow" style="background-color: ${getComputedStyle(document.documentElement).getPropertyValue('--error-color')}; color: white; border: none; border-radius: 50%; cursor: pointer; width:22px; height:22px; line-height:22px; text-align:center; padding:0; flex-shrink:0;">-</button>`;
                container.appendChild(div);
                
                div.querySelector('.tcrRemoveRow').addEventListener('click', () => {
                    if (container.querySelectorAll('div').length > 1) {
                        div.remove();
                        validateTCR();
                    }
                });

                div.querySelectorAll('input').forEach(input => input.addEventListener('input', validateTCR));
            };

            document.getElementById('tcrAddRow').addEventListener('click', () => addRow());
            addRow('2', '3'); addRow('3', '5'); addRow('2', '7');
            
            document.getElementById('tcrExecute').addEventListener('click', () => {
                try {
                    const congruences = [];
                    container.querySelectorAll('div').forEach(row => {
                        const a = parseInt(row.querySelector('.tcrA').value, 10);
                        const n = parseInt(row.querySelector('.tcrN').value, 10);
                        if (!isNaN(a) && !isNaN(n)) congruences.push({ a, n });
                    });
                    const { result, steps } = this.chinese_remainder_theorem(congruences);
                    document.getElementById('tcrResultText').textContent = result;
                    this.updateTable('tcrStepsTable', ['Paso', 'Cálculo', 'Resultado'], steps, ['step', 'calc', 'res']);
                } catch (e) {
                    modal.show('Error en T. Chino del Residuo', e.message);
                }
            });

            validateTCR();
        }
    };
    app.init();
});
</script>
</body>
</html>

